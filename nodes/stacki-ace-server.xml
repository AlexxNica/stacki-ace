<?xml version="1.0" standalone="no"?>

<kickstart>


<description>
</description>


<package>stacki-ace-install</package>
<package>stacki-ace-images</package>
<package>stacki-ace-profile</package>
<package>stacki-ace-command</package>

<package>nfs-utils</package>
<package>dosfstools</package>
<package>ntp</package>

<package>lighttpd</package>


<post>

<!-- time configuration -->

<file name="/etc/sysconfig/ntpd">
OPTIONS="-A -u ntp:ntp -p /var/run/ntpd.pid"
</file>

<file name="/etc/ntp.conf">
server pool.ntp.org iburst
server 127.127.1.1 iburst
fudge 127.127.1.1 stratum 10
driftfile /var/lib/ntp/drift
</file>

/usr/sbin/ntpdate -s pool.ntp.org

/usr/bin/systemctl enable ntpd
/usr/bin/systemctl start ntpd

<file name="/opt/stack/bin/stacki-time.sh" perms="700">
#!/bin/sh
/usr/sbin/ntpdate -s pool.ntp.org
</file>


<!-- configure the NFS server to accept v2 requests -->

<file name="/etc/sysconfig/nfs">
RPCNFSDARGS="-V 2"
RPCMOUNTDOPTS=""
STATDARG=""
SMNOTIFYARGS=""
RPCIDMAPDARGS=""
RPCGSSDARGS=""
GSS_USE_PROXY="yes"
RPCSVCGSSDARGS=""
BLKMAPDARGS=""
</file>

mkdir -p /export/nfs/install

<file name="/etc/exports">
/export/nfs/install &Kickstart_PrivateNetwork;/&Kickstart_PrivateNetmaskCIDR;(rw,sync,no_subtree_check,no_root_squash,insecure)
</file>

rsync -xa --exclude /export / /export/nfs/install

rm /export/nfs/install/etc/fstab
rm /export/nfs/install/etc/hostname
rm /export/nfs/install/etc/sysconfig/network
rm /export/nfs/install/etc/sysconfig/network-scripts/ifcfg-eth*

<file name="/export/nfs/install/etc/sysconfig/network-scripts/ifcfg-eth0">
DEVICE=eth0
BOOTPROTO=dhcp
ONBOOT=yes
MTU=1500
</file>

<file name="/export/nfs/install/tmp/stack.conf">
var.trackers = "&Kickstart_PrivateAddress;"
var.pkgservers = "&Kickstart_PrivateAddress;"
</file>

cp /opt/stack/systemd/stacki-install.service /export/nfs/install/usr/lib/systemd/system/

echo "/usr/bin/systemctl enable stacki-install" > /export/nfs/install/tmp/systemctl.stacki
chmod a+x /export/nfs/install/tmp/systemctl.stacki

chroot /export/nfs/install /tmp/systemctl.stacki
</post>


<post>
mkdir -p /tftpboot/pxelinux/
cp /opt/stack/images/armv7hl/* /tftpboot/pxelinux/

<file name="/tftpboot/pxelinux/cmdline.txt">
root=/dev/nfs nfsroot=&Kickstart_PrivateAddress;:/export/nfs/install rootwait ip=dhcp frontend=&Kickstart_PrivateAddress;
</file>

<file name="/tftpboot/pxelinux/config.txt">
program_usb_boot_mode=1
</file>

</post>

<post>
/usr/bin/systemctl enable nfs-server

/usr/sbin/exportfs -r

/usr/bin/systemctl start nfs-server
</post>

<post>

<!-- default ACE backend node -->

/opt/stack/bin/stack add appliance ace longname=ACE
/opt/stack/bin/stack set appliance attr ace attr=managed value=true
/opt/stack/bin/stack set appliance attr ace attr=kickstartable value=yes
/opt/stack/bin/stack set appliance attr ace attr=node value=stacki-ace-backend

<!-- backend node used to build a generic CentOS image -->

/opt/stack/bin/stack add appliance ace-centos longname=ACE-CentOS 
/opt/stack/bin/stack set appliance attr ace-centos attr=managed value=true
/opt/stack/bin/stack set appliance attr ace-centos attr=kickstartable value=yes
/opt/stack/bin/stack set appliance attr ace-centos attr=node \
	value=stacki-ace-centos

/opt/stack/bin/stack add box ace-centos


<!-- default boot disk is the micro SD card -->

/opt/stack/bin/stack set attr attr=bootdisk value=mmcblk0

<!-- symbolic link to installation folder -->
mkdir -p /run/mnt/sysimage/install
ln -s /run/mnt/sysimage/install /export/nfs/install/install
rmdir /run/mnt/sysimage/install

sed -i 's/tmp/run/' /export/nfs/install/opt/lighttpd/conf/lighttpd.conf
sed -i 's/&Kickstart_PrivateAddress;/127.0.0.1/' /export/nfs/install/etc/yum.repos.d/stacki.repo
</post>


</kickstart> 

